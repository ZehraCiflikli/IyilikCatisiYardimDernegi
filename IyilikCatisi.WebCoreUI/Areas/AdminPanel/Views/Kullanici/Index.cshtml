@section ContentHeader
{
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modalKullaniciEkle">
        Kullanıcı Ekle
    </button>
}

@model KullaniciIndexViewModel
<div class="col-12">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Kullanıcılar</h3>
        </div>
        <!-- /.card-header -->
        <div class="card-body">
            <table id="tblKullanicilar" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>No</th>
                        <th>Fotoğraf</th>
                        <th>Ad</th>
                        <th>Soyad</th>
                        <th>Email</th>
                        <th>Cep Telefonu</th>
                        <th>Roller</th>
                        <th>Aktif</th>
                        <th>Diğer Bilgiler</th>
                        <th>Düzenle</th>
                        <th>Sil</th>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- /.card-body -->
    </div>
</div>

@section Styles {

    <link href="~/adminassets/plugins/bootstrap-switch/css/bootstrap3/bootstrap-switch.css" rel="stylesheet" />

}

<form id="frmKullaniciEkle">
    <div class="modal fade" id="modalKullaniciEkle">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Kullanıcı Ekleme Paneli</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="card-body">
                      
                        <div class="form-group">
                            <label>Fotoğraf</label>
                            <br />
                            <img id="Resim" src="/adminassets/img/person.png" width="60" />
                            <input id="KullaniciFoto" type="file" />
                        </div>
                        <div class="form-group">
                            <label>Adı</label>
                            <input type="text" class="form-control" asp-for="Adi" placeholder="Adı">
                        </div>
                        <div class="form-group">
                            <label>Soyadı</label>
                            <input type="text" class="form-control" asp-for="Soyadi" placeholder="Soyadı">
                        </div>
                        <div class="form-group">
                            <label>Eposta</label>
                            <input type="email" class="form-control" asp-for="Email" placeholder="Eposta">
                        </div>
                        <div class="form-group">
                            <label>Cep Telefonu</label>
                            <input type="text" class="form-control" asp-for="CepTel" placeholder="Cep Telefonu">
                        </div>
                        <div class="form-group">
                            <label>Şifre</label>
                            <input type="password" class="form-control" asp-for="Sifre" placeholder="*******">
                        </div>
                        <div class="form-group">
                            <label>Roller</label>
                            @* <input type="text" class="form-control select2" asp-for="Roller" placeholder="Roller"> *@
                            <select class="select2" asp-items="Model.Rols" asp-for="RolIds" multiple></select>
                        </div>



                    </div>
                    <!-- /.card-body -->
                </div>

                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">VAZGEÇ</button>
                    <button type="button" id="btnKullaniciEkle" class="btn btn-primary">KAYDET</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

</form>

<form id="frmDigerBilgiler">
    <div class="modal fade" id="modalDigerBilgilerGoruntule">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Kullanıcı Diğer Bilgiler</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="card-body">
                        <div class="form-group">
                            <label>TC Kimlik No</label>
                            <input type="number" class="form-control" asp-for="TcKimlikNo" placeholder="TC Kimlik No">
                        </div>
                        <div class="form-group">
                            <label>Doğum Tarihi</label>
                            <input type="date" class="form-control" asp-for="DogumTarihi" placeholder="Doğum Tarihi">
                        </div>
                        <div class="form-group">
                            <label>Üyelik Tarihi</label>
                            <input type="datetime-local" class="form-control" asp-for="UyelikTarihi" placeholder="Üyelik Tarihi">
                        </div>
                        <div class="form-group">
                            <label>Adres</label>
                            <textarea asp-for="Adres"></textarea>
                        </div>
                        

                    </div>
                    <!-- /.card-body -->




                </div>
                
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

</form>


<form id="frmKullaniciGuncelle">
    <div class="modal fade" id="modalKullaniciGuncelle">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Kullanıcı Güncelleme Paneli</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="card-body">
                       
                        <div class="form-group">
                            <input type="hidden" class="form-control" id="GId">

                            <label>Ad</label>
                            <input type="text" class="form-control" id="GAdi" placeholder="Ad">
                        </div>
                        <div class="form-group">
                            <label>Soyad</label>
                            <input type="text" class="form-control" id="GSoyadi" placeholder="Soyad">
                        </div>
                        <div class="form-group">
                            <label>Eposta</label>
                            <input type="email" class="form-control" id="GEmail" placeholder="Eposta">
                        </div>
                        <div class="form-group">
                            <label>Cep Telefonu</label>
                            <input type="number" class="form-control" id="GCepTel" placeholder="Cep Telefonu">
                        </div>
                        <div class="form-group">
                            <label>TC Kimlik No</label>
                            <input type="number" class="form-control" id="GTcKimlikNo" placeholder="TC Kimlik No">
                        </div>
                        <div class="form-group">
                            <label>Doğum Tarihi</label>
                            <input type="date" class="form-control" id="GDogumTarihi" placeholder="Doğum Tarihi">
                        </div>  
                        @* <div class="form-group">
                            <label>Roller</label>
                            <select class="select2" asp-items="Model.Rols" asp-for="RolIds"></select>
                        </div> *@
                        <div class="form-group">
                            <label>Adres</label>
                            <br />
                            <textarea id="GAdres"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="RolIds">Roller</label>
                            <select class="select2" asp-for="GRolIds" asp-items="Model.Rols" multiple></select>
                        </div>

                         <div class="form-group">
                            <label>Fotoğraf</label>
                            <br />
                            <img id="GResim" src="/adminassets/img/person.png" width="60" />
                            <input id="GKullaniciFoto" type="file" />
                        </div>

                    </div>
                    <!-- /.card-body -->




                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">VAZGEÇ</button>
                    <button type="button" id="btnKullaniciGuncelle" class="btn btn-primary">GÜNCELLE</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

</form>


@section Scripts {

    <script>

        var table;


        function DataTableGenerate() {

            table = $("#tblKullanicilar").DataTable({
                "dom": "Bfrtip",
                "responsive": true,
                "lengthChange": true,
                "pageLength": 10,
                "autoWidth": false,
                "buttons": ["csv", "excel", "pdf", "print", "colvis"],
                language: {
                    url: '/json/datatablestr.json',
                },
                ajax: { url: '/AdminPanel/Kullanici/KullaniciListele', type: 'post' },
                columns: [
                    { data: 'id', visible: false },
                    { data: 'id' },  //sirano
                    { data: 'resim' },
                    { data: 'adi' },
                    { data: 'soyadi' },
                    { data: 'email' },
                    { data: 'cepTel' },
                    { data: 'roller' },
                    { data: 'aktif' },
                    { data: 'id' },
                    { data: 'id' },
                    { data: 'id' },


                ],
                columnDefs: [
                    {
                        targets: 1,
                        render: function (data, type, row, meta) {

                            return meta.row+1;

                        }
                    },
                    {
                        targets: 2,
                        render: function (data, type, row, meta) {

                            if (data == null) {
                                return "<img  src='/adminassets/img/person.png' width='30px' />";

                            }
                            return "<img categoryName='" + row["kategoriAdi"] + "' class='categoryimage'  src='" + data + "' width='60px' />";

                        }
                    },
                    {
                        targets: 7,
                        render: function (data, type, row, meta) {

                            return data.join(',');

                        }
                    },

                    {
                        targets: 8,
                        render: function (data, type, row, meta) {

                            var kid = row["id"];

                            if (data)

                                return '<input kid=' + kid + '  type= "checkbox" data-on-text="AKTİF" data-off-text="PASİF" name = "my-checkbox" checked data-bootstrap-switch data-off-color="danger" class="chkAktif" data-on-color="success" > ';


                            else

                                return '<input kid=' + kid + '  type= "checkbox" data-on-text="AKTİF" data-off-text="PASİF" name = "my-checkbox"  data-bootstrap-switch data-off-color="danger" class="chkAktif" data-on-color="success" > ';

                        }
                    },
                    {
                        targets: 9,
                        render: function (data, type, row, meta) {

                            return "<a class='btn btn-info btnDigerBilgiler' kid=" + data + ">   <i class='fas fa-book'></i> GÖRÜNTÜLE</a > ";

                        }
                    },

                    {
                        targets: 10,
                        render: function (data, type, row, meta) {

                            return "<a class='btn btn-info btnDuzenle' kid=" + data + ">   <i class='fas fa-pencil-alt'></i></a > ";

                        }
                    },

                    {
                        targets: 11,
                        render: function (data, type, row, meta) {

                            return "<a class='btn btn-danger btnSil' kid=" + data + "><i class='fas fa-trash'></i></a > ";
                        }
                    },




                ],

                initComplete: function (settings, json) {

                    // Datatable initilize olduğunda
                    $("input[data-bootstrap-switch]").each(function () {
                        $(this).bootstrapSwitch();
                    });
                },

                drawCallback: function () {

                    // Arama Yapıldığında, Sayfalama Yapıldığında, Sıralama Yapıldığında Draw yapılıyor
                    $("input[data-bootstrap-switch]").each(function () {
                        $(this).bootstrapSwitch();
                    })                             
                }

            }).buttons().container().appendTo('#tblKullanicilar_wrapper .col-md-6:eq(0)');

        };


        $(function () {
             DataTableGenerate();
        });



        $("#btnKullaniciEkle").click(function () {

            var swal = Swal.fire({
                title: "LÜTFEN BEKLEYİNİZ...",
                html: "İşleminiz Yapılıyor",
                timerProgressBar: true,
                didOpen: () => {

                    Swal.showLoading();
                },
            });

            var formData = new FormData();

             
            var Adi = $("#Adi").val();  ///vm içindeki yazım
            var Soyadi = $("#Soyadi").val();
            var Eposta = $("#Email").val();
            var CepTel = $("#CepTel").val();
            var RolIds = $("#RolIds").val();
            var Sifre = $("#Sifre").val();
            debugger
            if ($("#KullaniciFoto")[0].files[0] != null) {

                var file = $("#KullaniciFoto")[0].files[0];
                formData.append("KullaniciFoto", file);

            }


            formData.append("Adi", Adi)                //form dataya attığım ismi-- değişken ismi
            formData.append("Soyadi", Soyadi)         //form dataya nasıl ekliyorsak controllerda o isimle data içine alıyoruz.
            formData.append("Email", Eposta)
            formData.append("CepTel", CepTel)
            formData.append("RolIds", RolIds)
            formData.append("Sifre", Sifre)


            $.ajax({
                url: "/AdminPanel/Kullanici/KullaniciEkle",
                type: "post",
                dataType: "json",
                processData: false,
                contentType: false,
                data: formData,
                success: function (r) {
                    if (r.result) {

                        $("#tblKullanicilar").DataTable().ajax.reload();

                        Swal.fire({
                            title: "İşlem Başarılı",
                            text: "Kullanıcı Başarıyla Eklendi.",
                            icon: "success"
                        });
                        $("#modalKullaniciEkle").modal("hide");
                    }
                },
                error: function () {

                }
            });

        });




        $(function () {
            $('.select2').select2()
            $("input[data-bootstrap-switch]").each(function () {
                $(this).bootstrapSwitch();
            })
            $(document).on('switchChange.bootstrapSwitch', '.chkAktif', function (event, state) {

                var swal = Swal.fire({
                    title: "LÜTFEN BEKLEYİNİZ...",
                    html: "İşleminiz Yapılıyor",
                    timerProgressBar: true,
                    didOpen: () => {

                        Swal.showLoading();

                    },
                });

                var id = $(this).attr('kid');
                var aktifpasif = state;
                $.ajax({
                    url: "/AdminPanel/Kullanici/AktifPasif",
                    type: "post",
                    dataType: "json",
                    data: { id: id, aktif: aktifpasif },
                    success: function (r) {

                        swal.close();
                        if (r.result) {
                            Swal.fire({
                                title: "İŞLEM BAŞARILI",
                                text: r.mesaj,
                                icon: "success"
                            });
                        }
                    },
                    error: function () {

                    }
                });
              
            });







            $(document).on('click', '.btnDuzenle', function () {
                var swal = Swal.fire({
                    title: "LÜTFEN BEKLEYİNİZ...",
                    html: "İşleminiz Yapılıyor",
                    timerProgressBar: true,
                    didOpen: () => {

                        Swal.showLoading();
                    },
                });

                var id = $(this).attr('kid');
                $("#GId").val(id);

                $.ajax({
                    url: "/AdminPanel/Kullanici/KullaniciBilgileriniGetir",
                    type: "post",
                    dataType: "json",
                    data: { id: id },
                    success: function (r) {

                        if (r.result) {

                          
                            $("#GAdi").val(r.model.adi);
                            $("#GSoyadi").val(r.model.soyadi);
                            $("#GEmail").val(r.model.email);
                            $("#GCepTel").val(r.model.cepTel);
                            $("#GTcKimlikNo").val(r.model.tcKimlikNo);
                            $("#GDogumTarihi").val(r.model.dogumTarihi.split('T')[0]);
                            $("#GAdres").val(r.model.adres);
                            $("#GResim").attr("src", r.model.resim);

                            $('#GRolIds').val(r.model.gRolIds);
                            $('#GRolIds').trigger('change'); // Notify any JS components that the value changed

                            $("#modalKullaniciGuncelle").modal('show');
                        }
                        swal.close();
                    },
                    error: function () {

                    }
                });
            });


            

            $(document).on('click', '.btnDigerBilgiler', function () {
                var swal = Swal.fire({
                    title: "LÜTFEN BEKLEYİNİZ...",
                    html: "İşleminiz Yapılıyor",
                    timerProgressBar: true,
                    didOpen: () => {

                        Swal.showLoading();

                    },
                });

                var id = $(this).attr('kid');
                $("#GId").val(id);

                $.ajax({
                    url: "/AdminPanel/Kullanici/DigerBilgiler",
                    type: "post",
                    dataType: "json",
                    data: { id: id },
                    success: function (r) {

                        if (r.result) {

                          
                            $("#TcKimlikNo").val(r.model.tcKimlikNo);
                            $("#DogumTarihi").val(r.model.dogumTarihi.split('T')[0]);
                            $("#UyelikTarihi").val(r.model.uyelikTarihi.split('.')[0]);
                            $("#Adres").val(r.model.adres);

                          
                             $("#modalDigerBilgilerGoruntule").modal('show');
                        }
                        swal.close();

                    },
                    error: function () {

                    }
                });
              
            });





            $(document).on('click', '#btnKullaniciGuncelle', function () {

                var swal = Swal.fire({
                    title: "LÜTFEN BEKLEYİNİZ...",
                    html: "İşleminiz Yapılıyor",
                    timerProgressBar: true,
                    didOpen: () => {

                        Swal.showLoading();

                    },
                });

                var formData = new FormData();

                // if ($("#GFUResim")[0].files[0] != null) {

                //     var file = $("#GFUResim")[0].files[0];
                //     formData.append(file.name, file);

                // }
                if ($("#GKullaniciFoto")[0].files[0] != null) {

                    var file = $("#GKullaniciFoto")[0].files[0];
                    formData.append("KullaniciFoto", file);

                }

              
                var Ad = $("#GAdi").val();
                var Soyadi = $("#GSoyadi").val();
                var Email = $("#GEmail").val();
                var CepTel = $("#GCepTel").val();
                var Tc = $("#GTcKimlikNo").val();
                var Dogum = $("#GDogumTarihi").val();
                var Adres = $("#GAdres").val();
                var Id = $("#GId").val();
                var SeciliOlanRoller = $("#GRolIds").val();


                // var model = {
                //     ID=Id,
                //     Aciklama=Aciklama //CONROLLERIN BEKLEDİĞİ -- DEĞİŞKEN
                // }
                // $('#FRMkULLANİCİ').serialize()

               
                formData.append("Adi", Ad)
                formData.append("Soyadi", Soyadi)
                formData.append("Email", Email)
                formData.append("CepTel", CepTel)
                formData.append("TcKimlikNo", Tc)
                formData.append("DogumTarihi", Dogum)
                formData.append("Adres", Adres)
                formData.append("Id", Id)
                formData.append("GRolIds", SeciliOlanRoller)


                $.ajax({
                    url: "/AdminPanel/Kullanici/Guncelle",
                    type: "post",
                    dataType: "json",
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function (r) {



                        $("#tblKullanicilar").DataTable().destroy();
  
                        DataTableGenerate();


                        $("#GResim").attr("src", r.model.resim);
                        var klist = "";

                        swal.close();
                        if (r.result) {
                            Swal.fire({
                                title: "İŞLEM BAŞARILI",
                                text: r.mesaj,
                                icon: "success"
                            });
                        }
                        $("#modalKullaniciGuncelle").modal("hide");

                    },
                    error: function () {

                    }
                }
                );



            });

            $(document).on('click', '.btnSil', function () {


                var id = $(this).attr('kid');

                Swal.fire({
                    title: "UYARI",
                    text: "Kullanıcılardan Silinecek Emin Misiniz?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "SİL!",
                    cancelButtonText: "VAZGEÇ!"
                }).then((result) => {
                    if (result.isConfirmed) {


                        $.ajax({
                            url: "/AdminPanel/Kullanici/KullaniciSil",
                            dataType: "json",
                            method: "post",
                            data: { id: id },
                            success: function (r) {

                                if (r.result) {
                                    Swal.fire({
                                        title: "İşlem Başarılı",
                                        text: "Kullanıcı Başarıyla Silindi.",
                                        icon: "success"
                                    });

                                    $("#tblKullanicilar").DataTable().ajax.reload();

                                }

                            },
                            error: function () {

                            }
                        });

                    }

                });


            });
        });

    </script>
}